<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>mysql问题 | Moon</title><meta name="keywords" content="mysql"><meta name="author" content="Kris"><meta name="copyright" content="Kris"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="# 事务特性 事务特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。  原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚。 一致性是指一个事务执行之前和执行之后都必须处于一致性状态。比如 a 与 b 账户共有 1000 块，两人之间转账之后无论成功还是失败，它们的账户总和还是 1000。 隔离性。跟隔离级别">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql问题">
<meta property="og:url" content="http://example.com/2021/09/05/mysql%E9%A2%98%E7%9B%AE/index.html">
<meta property="og:site_name" content="Moon">
<meta property="og:description" content="# 事务特性 事务特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。  原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚。 一致性是指一个事务执行之前和执行之后都必须处于一致性状态。比如 a 与 b 账户共有 1000 块，两人之间转账之后无论成功还是失败，它们的账户总和还是 1000。 隔离性。跟隔离级别">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/me.png">
<meta property="article:published_time" content="2021-09-05T14:02:14.000Z">
<meta property="article:modified_time" content="2021-09-05T14:06:02.039Z">
<meta property="article:author" content="Kris">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/me.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/09/05/mysql%E9%A2%98%E7%9B%AE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"top-center"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mysql问题',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-09-05 22:06:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="/css/custom.css"  media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.1.6/css/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiperstyle.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/me1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-quran"></i><span> 笔记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-clock"></i><span> 时间线</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> 爱好</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/picture/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw far fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-moon"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/me.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Moon</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-quran"></i><span> 笔记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-clock"></i><span> 时间线</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> 爱好</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/picture/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw far fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-moon"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mysql问题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-09-05T14:02:14.000Z" title="发表于 2021-09-05 22:02:14">2021-09-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-09-05T14:06:02.039Z" title="更新于 2021-09-05 22:06:02">2021-09-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>31分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="mysql问题"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2021/09/05/mysql%E9%A2%98%E7%9B%AE/#post-comment"><span id="twikoo-count"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="事务特性"><a class="markdownIt-Anchor" href="#事务特性">#</a> 事务特性</h2>
<p>事务特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。</p>
<ul>
<li>原子性是指事务包含的所有操作要么全部成功，要么全部失败回滚。</li>
<li>一致性是指一个事务执行之前和执行之后都必须处于一致性状态。比如 a 与 b 账户共有 1000 块，两人之间转账之后无论成功还是失败，它们的账户总和还是 1000。</li>
<li>隔离性。跟隔离级别相关，如 read committed，一个事务只能读到已经提交的修改。</li>
<li>持久性是指一个事务一旦被提交了，那么对数据库中的数据的改变就是永久性的，即便是在数据库系统遇到故障的情况下也不会丢失提交事务的操作。</li>
</ul>
<h2 id="事务隔离级别"><a class="markdownIt-Anchor" href="#事务隔离级别">#</a> 事务隔离级别</h2>
<p>先了解下几个概念：脏读、不可重复读、幻读。</p>
<ul>
<li>脏读是指在一个事务处理过程里读取了另一个未提交的事务中的数据。</li>
<li>不可重复读是指在对于数据库中的某行记录，一个事务范围内多次查询却返回了不同的数据值，这是由于在查询间隔，另一个事务修改了数据并提交了。</li>
<li>幻读是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行，就像产生幻觉一样，这就是发生了幻读。</li>
</ul>
<p>不可重复读和脏读的区别是，脏读是某一事务读取了另一个事务未提交的脏数据，而不可重复读则是读取了前一事务提交的数据。<br>
幻读和不可重复读都是读取了另一条已经提交的事务，不同的是不可重复读的重点是修改，幻读的重点在于新增或者删除。</p>
<p>事务隔离就是为了解决上面提到的脏读、不可重复读、幻读这几个问题。</p>
<p>MySQL 数据库为我们提供的四种隔离级别：</p>
<ul>
<li>Serializable (串行化)：通过强制事务<a href="">排序</a>，使之不可能相互冲突，从而解决幻读问题。</li>
<li>Repeatable read (可重复读)：MySQL 的默认事务隔离级别，它确保同一事务的多个实例在并发读取数据时，会看到同样的数据行，解决了不可重复读的问题。</li>
<li>Read committed (读已提交)：一个事务只能看见已经提交事务所做的改变。可避免脏读的发生。</li>
<li>Read uncommitted (读未提交)：所有事务都可以看到其他未提交事务的执行结果。</li>
</ul>
<p>查看隔离级别：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`select` `@@transaction_isolation;`</span><br></pre></td></tr></table></figure>
<p>设置隔离级别：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`set` `session ``transaction` `isolation` `level` `read` `uncommitted``;`</span><br></pre></td></tr></table></figure>
<h2 id="索引"><a class="markdownIt-Anchor" href="#索引">#</a> 索引</h2>
<p>索引是存储引擎用于提高数据库表的访问速度的一种数据结构。</p>
<p>特点：1、避免进行数据库全表的扫描，大多数情况，只需要扫描较少的索引页和数据页；提升查询语句的执行效率，但降低了新增、删除操作的速度，同时也会占用额外的存储空间。</p>
<h3 id="索引的作用"><a class="markdownIt-Anchor" href="#索引的作用">#</a> 索引的作用</h3>
<p>数据是存储在磁盘上的，查询数据时，如果没有索引，会加载所有的数据到内存，依次进行检索，读取磁盘次数较多。有了索引，就不需要加载所有数据，因为 B + 树的高度一般在 2-4 层，最多只需要读取 2-4 次磁盘，查询速度大大提升。</p>
<p>什么情况下需要建索引：</p>
<ol>
<li>经常用于查询的字段</li>
<li>经常用于连接的字段（如外键）建立索引，可以加快连接的速度</li>
<li>经常需要<a href="">排序</a>的字段建立索引，因为索引已经排好序，可以加快<a href="">排序</a>查询速度</li>
</ol>
<p>什么情况下不建索引？</p>
<ol>
<li>where 条件中用不到的字段不适合建立索引</li>
<li>表记录较少</li>
<li>需要经常增删改</li>
<li>参与列计算的列不适合建索引</li>
<li>区分度不高的字段不适合建立索引，性别等</li>
</ol>
<h3 id="b-树"><a class="markdownIt-Anchor" href="#b-树">#</a> B+ 树</h3>
<p>B+ 树是基于 B 树和叶子节点顺序访问指针进行实现，它具有 B 树的平衡性，并且通过顺序访问指针来提高区间查询的性能。</p>
<p>在 B+ 树中，节点中的 key 从左到右递增排列，如果某个指针的左右相邻 key 分别是 keyi 和 keyi+1，则该指针指向节点的所有 key 大于等于 keyi 且小于等于 keyi+1。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917423/image-20210821165019147.png" alt="img"></p>
<p>进行查找操作时，首先在根节点进行<a href="">二分查找</a>，找到 key 所在的指针，然后递归地在指针所指向的节点进行查找。直到查找到叶子节点，然后在叶子节点上进行<a href="">二分查找</a>，找出 key 所对应的数据项。</p>
<p>MySQL 数据库使用最多的索引类型是 BTREE 索引，底层基于 B + 树数据结构来实现。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`mysql&gt; show ``index` `from` `blog\G;``*************************** 1. row ***************************``        ``Table``: blog``   ``Non_unique: 0``     ``Key_name: ``PRIMARY`` ``Seq_in_index: 1``  ``Column_name: blog_id``    ``Collation: A``  ``Cardinality: 4``     ``Sub_part: ``NULL``       ``Packed: ``NULL``         ``Null``:``   ``Index_type: BTREE``      ``Comment:``Index_comment:``      ``Visible: YES``   ``Expression: ``NULL`</span><br></pre></td></tr></table></figure>
<h3 id="索引实例"><a class="markdownIt-Anchor" href="#索引实例">#</a> 索引实例</h3>
<p>下面来看看一个索引的例子：</p>
<p>如下图，col1 是主键，col2 和 col3 是普通字段。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917471/image-20200520234137916.png" alt="img"></p>
<p>下图是主键索引对应的 B + 树结构，每个节点对应磁盘的一页。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917461/image-20200520234200868.png" alt="img"></p>
<p>对 col3 建立一个单列索引，对应的 B + 树结构：</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917509/image-20200520234231001.png" alt="img"></p>
<h3 id="索引分类"><a class="markdownIt-Anchor" href="#索引分类">#</a> 索引分类</h3>
<ol>
<li>
<p>主键索引：名为 primary 的唯一非空索引，不允许有空值。</p>
</li>
<li>
<p>唯一索引：索引列中的值必须是唯一的，但是允许为空值。</p>
<p>唯一索引和主键索引的区别是：UNIQUE 约束的列可以为 null 且可以存在多个 null 值。UNIQUE KEY 的用途：唯一标识数据库表中的每条记录，主要是用来防止数据重复插入。</p>
<p>创建唯一索引：</p>
<p><a href="#">复制代码</a></p>
<p><code>ALTER</code>   <code>TABLE</code>   <code>table_name``ADD</code>   <code>CONSTRAINT</code>   <code>constraint_name ``UNIQUE</code>   <code>KEY``(column_1,column_2,...);</code></p>
</li>
<li>
<p>组合索引：在表中的多个字段组合上创建的索引，只有在查询条件中使用了这些字段的左边字段时，索引才会被使用，使用组合索引时遵循最左前缀原则。</p>
</li>
<li>
<p>全文索引：全文索引，只有在 MyISAM 引擎上才能使用，只能在 CHAR,VARCHAR,TEXT 类型字段上使用全文索引。</p>
</li>
</ol>
<h3 id="最左匹配"><a class="markdownIt-Anchor" href="#最左匹配">#</a> 最左匹配</h3>
<p>如果 SQL 语句中用到了组合索引中的最左边的索引，那么这条 SQL 语句就可以利用这个组合索引去进行匹配。当遇到范围查询 (&gt;、&lt;、between、like) 就会停止匹配，后面的字段不会用到索引。</p>
<p>对 (a,b,c) 建立索引，查询条件使用 a/ab/abc 会走索引，使用 bc 不会走索引。</p>
<p>对 (a,b,c,d) 建立索引，查询条件为 <code>a = 1 and b = 2 and c &gt; 3 and d = 4</code> ，那么，a,b,c 三个字段能用到索引，而 d 就匹配不到。因为遇到了范围查询！</p>
<p>对 (a, b) 建立索引，a 在索引树中是全局有序的，而 b 是全局无序，局部有序（当 a 相等时，会对 b 进行比较<a href="">排序</a>）。直接执行 <code>b = 2</code>  这种查询条件没有办法利用索引。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917475/image-20210821103313578.png" alt="最左匹配"></p>
<p>从局部来看，当 a 的值确定的时候，b 是有序的。例如 a = 1 时，b 值为 1，2 是有序的状态。当 a=2 时候，b 的值为 1,4 也是有序状态。 因此，你执行 <code>a = 1 and b = 2</code>  是 a,b 字段能用到索引的。而你执行 <code>a &gt; 1 and b = 2</code>  时，a 字段能用到索引，b 字段用不到索引。因为 a 的值此时是一个范围，不是固定的，在这个范围内 b 值不是有序的，因此 b 字段用不上索引。</p>
<h3 id="聚集索引"><a class="markdownIt-Anchor" href="#聚集索引">#</a> 聚集索引</h3>
<p>InnoDB 使用表的主键构造主键索引树，同时叶子节点中存放的即为整张表的记录数据。聚集索引叶子节点的存储是逻辑上连续的，使用双向<a href="">链表</a>连接，叶子节点按照主键的顺序<a href="">排序</a>，因此对于主键的<a href="">排序</a>查找和范围查找速度比较快。</p>
<p>聚集索引的叶子节点就是整张表的行记录。InnoDB 主键使用的是聚簇索引。聚集索引要比非聚集索引查询效率高很多。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917550/mysql-clustered-index.png" alt="img"></p>
<p>对于 InnoDB 来说，聚集索引一般是表中的主键索引，如果表中没有显示指定主键，则会选择表中的第一个不允许为 NULL 的唯一索引。如果没有主键也没有合适的唯一索引，那么 innodb 内部会生成一个隐藏的主键作为聚集索引，这个隐藏的主键长度为 6 个字节，它的值会随着数据的插入自增。</p>
<h3 id="覆盖索引"><a class="markdownIt-Anchor" href="#覆盖索引">#</a> 覆盖索引</h3>
<p>select 的数据列只用从索引中就能够取得，不需要到数据表进行二次查询，换句话说查询列要被所使用的索引覆盖。对于 innodb 表的二级索引，如果索引能覆盖到查询的列，那么就可以避免对主键索引的二次查询。</p>
<p>不是所有类型的索引都可以成为覆盖索引。覆盖索引要存储索引列的值，而哈希索引、全文索引不存储索引列的值，所以 MySQL 只能使用 b + 树索引做覆盖索引。</p>
<p>对于使用了覆盖索引的查询，在查询前面使用 explain，输出的 extra 列会显示为 using index。</p>
<p>比如 user_like 用户点赞表，组合索引为 (user_id, blog_id)，user_id 和 blog_id 都不为 null。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`explain ``select` `blog_id ``from` `user_like ``where` `user_id = 13;`</span><br></pre></td></tr></table></figure>
<p>Extra 中为 <code>Using index</code> ，查询的列被索引覆盖，并且 where 筛选条件符合最左前缀原则，通过<strong>索引查找</strong>就能直接找到符合条件的数据，不需要回表查询数据。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`explain ``select` `user_id ``from` `user_like ``where` `blog_id = 1;`</span><br></pre></td></tr></table></figure>
<p>Extra 中为 <code>Using where; Using index</code> ， 查询的列被索引覆盖，where 筛选条件不符合最左前缀原则，无法通过索引查找找到符合条件的数据，但可以通过<strong>索引扫描</strong>找到符合条件的数据，也不需要回表查询数据。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917790/cover-index.png" alt="img"></p>
<h3 id="索引失效"><a class="markdownIt-Anchor" href="#索引失效">#</a> 索引失效</h3>
<p>导致索引失效的情况：</p>
<ul>
<li>对于组合索引，不是使用组合索引最左边的字段，则不会使用索引</li>
<li>以 % 开头的 like 查询如 <code>%abc</code> ，无法使用索引；非 % 开头的 like 查询如 <code>abc%</code> ，相当于范围查询，会使用索引</li>
<li>查询条件中列类型是字符串，没有使用引号，可能会因为类型不同发生隐式转换，使索引失效</li>
<li>判断索引列是否不等于某个值时</li>
<li>对索引列进行运算</li>
<li>使用 or 连接的条件，如果左边的字段有索引，右边的字段没有索引，那么左边的索引会失效</li>
</ul>
<p>对于 Java 选手来说，基础知识非常重要，这里给大家分享一个超全面的 Java 知识总结，<strong>GitHub 标星 137k</strong>+，非常有用！</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210827/8683776_1630025317873/v2-cdfb49d3d6562191415ae9771055807a.jpg" alt="img"></p>
<p>有需要的小伙伴可以自行下载：</p>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=Mzg2OTY1NzY0MQ==&amp;mid=100000392&amp;idx=1&amp;sn=f6c8e84651ce48f6ef5b0d496f0f6adf&amp;chksm=4e98ffce79ef76d8dcebdc4787ae8b37760ec193574da9036e46954ae8954ebd56c78792726f#rd">Java 知识总结，GitHub 标星 137k+</a></p>
<h2 id="存储引擎"><a class="markdownIt-Anchor" href="#存储引擎">#</a> 存储引擎</h2>
<p>MySQL 5.5 版本后默认的存储引擎为 InnoDB。</p>
<h3 id="innodb"><a class="markdownIt-Anchor" href="#innodb">#</a> InnoDB</h3>
<p>InnoDB 是 MySQL 默认的事务型存储引擎，使用最广泛，基于聚簇索引建立的。InnoDB 内部做了很多优化，如能够自动在内存中创建自适应 hash 索引，以加速读操作。</p>
<p><strong>优点</strong>：支持事务和崩溃修复能力。InnoDB 引入了行级锁和外键约束。</p>
<p><strong>缺点</strong>：占用的数据空间相对较大。</p>
<p><strong>适用场景</strong>：需要事务支持，并且有较高的并发读写频率。</p>
<h3 id="myisam"><a class="markdownIt-Anchor" href="#myisam">#</a> MyISAM</h3>
<p>数据以紧密格式存储。对于只读数据，或者表比较小、可以容忍修复操作，可以使用 MyISAM 引擎。MyISAM 会将表存储在两个文件中，数据文件.MYD 和索引文件.MYI。</p>
<p><strong>优点</strong>：访问速度快。</p>
<p><strong>缺点</strong>：MyISAM 不支持事务和行级锁，不支持崩溃后的安全恢复，也不支持外键。</p>
<p><strong>适用场景</strong>：对事务完整性没有要求；只读的数据，或者表比较小，可以忍受修复 repair 操作。</p>
<p>MyISAM 特性：</p>
<ol>
<li>MyISAM 对整张表加锁，而不是针对行。读取数据时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在读取表记录的同时，可以往表中插入新的记录（并法插入）。</li>
<li>对于 MyISAM 表，MySQL 可以手动或者自动执行检查和修复操作。执行表的修复可能会导致数据丢失，而且修复操作非常慢。可以通过 <code>CHECK TABLE tablename</code>  检查表的错误，如果有错误执行 <code>REPAIR TABLE tablename</code>  进行修复。</li>
</ol>
<h3 id="memory"><a class="markdownIt-Anchor" href="#memory">#</a> MEMORY</h3>
<p>MEMORY 引擎将数据全部放在内存中，访问速度较快，但是一旦系统奔溃的话，数据都会丢失。</p>
<p>MEMORY 引擎默认使用哈希索引，将键的哈希值和指向数据行的指针保存在哈希索引中。哈希索引使用拉链法来处理哈希冲突。</p>
<p><strong>优点</strong>：访问速度较快。</p>
<p><strong>缺点</strong>：</p>
<ol>
<li>哈希索引数据不是按照索引值顺序存储，无法用于<a href="">排序</a>。</li>
<li>不支持部分索引匹配查找，因为哈希索引是使用索引列的全部内容来计算哈希值的。</li>
<li>只支持等值比较，不支持范围查询。</li>
<li>当出现哈希冲突时，存储引擎需要遍历<a href="">链表</a>中所有的行指针，逐行进行比较，直到找到符合条件的行。</li>
</ol>
<h3 id="myisam和innodb区别"><a class="markdownIt-Anchor" href="#myisam和innodb区别">#</a> MyISAM 和 InnoDB 区别</h3>
<ol>
<li>
<p><strong>是否支持行级锁</strong> : MyISAM 只有表级锁，而 InnoDB 支持行级锁和表级锁，默认为行级锁。</p>
</li>
<li>
<p><strong>是否支持事务和崩溃后的安全恢复</strong>： MyISAM 强调的是性能，每次查询具有原子性，其执行速度比 InnoDB 类型更快，但是不提供事务支持。但是 InnoDB 提供事务支持，具有事务、回滚和崩溃修复能力。</p>
</li>
<li>
<p><strong>是否支持外键：</strong> MyISAM 不支持，而 InnoDB 支持。</p>
</li>
<li>
<p><strong>是否支持 MVCC</strong> ：仅 InnoDB 支持。应对高并发事务，MVCC 比单纯的加锁更高效；MVCC 只在  <code>READ COMMITTED</code>  和  <code>REPEATABLE READ</code>  两个隔离级别下工作；MVCC 可以使用乐观锁和悲观锁来实现；各数据库中 MVCC 实现并不统一。</p>
</li>
<li>
<p>MyISAM 不支持聚集索引，InnoDB 支持聚集索引。</p>
<p>myisam 引擎主键索引和其他索引区别不大，叶子节点都包含索引值和行指针。<br>
innodb 引擎二级索引叶子存储的是索引值和主键值（不是行指针），这样可以减少行移动和数据页分裂时二级索引的维护工作。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917803/myisam-innodb-index.png" alt="myisam-innodb-index"></p>
</li>
</ol>
<h2 id="mvcc"><a class="markdownIt-Anchor" href="#mvcc">#</a> MVCC</h2>
<p>MVCC( <code>Multiversion concurrency control</code> ) 就是同一份数据保留多版本的一种方式，进而实现并发控制。可以认为 MVCC 是行级锁的变种。在查询的时候，通过 read view 和版本链找到对应版本的数据。</p>
<p>MVCC 只适用于 read committed 和 repeatable read。使用事务更新行记录时，会生成一个新的版本的行记录。</p>
<p>作用：提升并发性能。对于高并发场景，MVCC 比行级锁更有效、开销更小。</p>
<h3 id="实现原理"><a class="markdownIt-Anchor" href="#实现原理">#</a> 实现原理</h3>
<p>mvcc 实现依赖于版本链，版本链是通过表的三个隐藏字段实现。</p>
<ul>
<li>事务 id：data_trx_id，当前事务 id</li>
<li>回滚指针：data_roll_ptr，指向当前行记录的上一个版本，通过这个指针将数据的多个版本连接在一起构成 undo log 版本链</li>
<li>主键：db_row_id，如果数据表没有主键，InnoDB 会自动生成主键</li>
</ul>
<p>使用事务更新行记录的时候，就会生成版本链：</p>
<ol>
<li>用排他锁锁住该行；</li>
<li>将该行原本的值拷贝到 undo log，作为旧版本用于回滚；</li>
<li>修改当前行的值，生成一个新版本，更新事务 id，使回滚指针指向旧版本的记录，这样就形成一条版本链；</li>
<li>记录 redo log；</li>
</ol>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917857/mvcc-impl.png" alt="img"></p>
<h3 id="read-view"><a class="markdownIt-Anchor" href="#read-view">#</a> read view</h3>
<p>read view 就是在某一时刻给事务打 snapshot 快照。在 read_view 内部维护一个活跃事务<a href="">链表</a>，这个<a href="">链表</a>包含在创建 read view 之前还未提交的事务，不包含创建 read view 之后提交的事务。</p>
<p>不同隔离级别创建 read view 的时机不同。</p>
<p>read committed：每次执行 select 都会创建新的 read_view，保证能读取到其他事务已经提交的修改。</p>
<p>repeatable read：在一个事务范围内，第一次 select 时更新这个 read_view，以后不会再更新，后续所有的 select 都是复用之前的 read_view。这样可以保证事务范围内每次读取的内容都一样，即可重复读。</p>
<h3 id="数据访问流程"><a class="markdownIt-Anchor" href="#数据访问流程">#</a> 数据访问流程</h3>
<p>当访问数据行时，会先判断当前版本数据项是否可见，如果是不可见的，会通过版本链找到一个可见的版本。</p>
<ul>
<li>如果数据行的当前版本 &lt; read view 最早的活跃事务 id：说明在创建 read_view 时，修改该数据行的事务已提交，该版本的数据行可被当前事务读取到。</li>
<li>如果数据行的当前版本 &gt;= read view 最晚的活跃事务 id：说明当前版本的数据行的事务是在创建 read_view 之后生成的，该版本的数据行不可以被当前事务访问。此时需要通过版本链找到上一个版本，然后重新判断该版本数据对当前事务的可见性。</li>
<li>如果数据行的当前版本在最早的活跃事务 id 和最晚的活跃事务 id 之间：
<ol>
<li>需要在活跃事务<a href="">链表</a>中查找是否包含该数据行的最新事务 id，即生成当前版本数据行的事务是否已经提交。</li>
<li>如果存在，说明生成当前版本数据行的事务未提交，所以该版本的数据行不能被当前事务访问。此时需要通过版本链找到上一个版本，然后重新判断该版本的可见性。</li>
<li>如果不存在，说明事务已经提交，可以直接读取该数据行。</li>
</ol>
</li>
</ul>
<p><strong>总结</strong>：通过比较 read view 和数据行的当前版本，找到当前事务可见的版本，进而实现 read commit 和 repeatable read 的事务隔离级别。</p>
<h3 id="快照读和当前读"><a class="markdownIt-Anchor" href="#快照读和当前读">#</a> 快照读和当前读</h3>
<p>记录的两种读取方式。</p>
<p>快照读：读取的是快照版本，也就是历史版本。普通的 SELECT 就是快照读。通过 MVCC 来进行控制的，不用加锁。</p>
<p>当前读：读取的是最新版本。UPDATE、DELETE、INSERT、SELECT … LOCK IN SHARE MODE、SELECT … FOR UPDATE 是当前读。</p>
<p>快照读情况下，InnoDB 通过 mvcc 机制避免了幻读现象。而 mvcc 机制无法避免当前读情况下出现的幻读现象。</p>
<p>事务 a 和事务 b 同时开启事务，事务 a 插入数据然后提交，事务 b 执行全表的 update，然后执行查询，查到了事务 A 中添加的数据。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917795/%E5%B9%BB%E8%AF%BB1.png" alt="img"></p>
<p>MySQL 如何实现避免幻读:</p>
<ul>
<li>在快照读情况下，MySQL 通过 mvcc 来避免幻读。</li>
<li>在当前读情况下，MySQL 通过 next-key 来避免幻读（加行锁和间隙锁来实现的）。</li>
</ul>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905917832/current-read.png" alt="img"></p>
<p>next-key 包括两部分：行锁和间隙锁。行锁是加在索引上的锁，间隙锁是加在索引之间的。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`select` `* ``from` `table` `where` `id&lt;6 lock ``in` `share mode;``--共享锁 锁定的是小于6的行和等于6的行``select` `* ``from` `table` `where` `id&lt;6 ``for` `update``;``--排他锁`</span><br></pre></td></tr></table></figure>
<p>实际上很多的<a href="">项目</a>中是不会使用到上面的两种方法的，串行化读的性能太差，而且其实幻读很多时候是我们完全可以接受的。</p>
<p>Serializable 隔离级别也可以避免幻读，会锁住整张表，并发性极低，一般很少使用。</p>
<h3 id="select-读取锁定"><a class="markdownIt-Anchor" href="#select-读取锁定">#</a> select 读取锁定</h3>
<p>在 SELECT 的读取锁定主要分为两种方式：共享锁和排他锁。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`SELECT` `... LOCK ``IN` `SHARE MODE　``SELECT` `... ``FOR` `UPDATE`</span><br></pre></td></tr></table></figure>
<p>这两种方式主要的不同在于 LOCK IN SHARE MODE 多个事务同时更新同一个表单时很容易造成死锁。这种情况最好使用 SELECT …FOR UPDATE。</p>
<p><code>select * from goods where id = 1 for update</code> ：申请排他锁的前提是，没有线程对该结果集的任何行数据使用排它锁或者共享锁，否则申请会受到阻塞。在进行事务操作时，MySQL 会对查询结果集的每行数据添加排它锁，其他线程对这些数据的更改或删除操作会被阻塞（只能读操作），直到该语句的事务被 commit 语句或 rollback 语句结束为止。</p>
<p>select… for update 使用注意事项</p>
<ol>
<li>for update 仅适用于 Innodb，且必须在事务范围内才能生效。</li>
<li>根据主键进行查询，查询条件为 like 或者不等于，主键字段产生表锁。</li>
<li>根据非索引字段进行查询，name 字段产生表锁。</li>
</ol>
<h2 id="分库分表"><a class="markdownIt-Anchor" href="#分库分表">#</a> 分库分表</h2>
<p>当单表的数据量达到 1000W 或 100G 以后，优化索引、添加从库等可能对数据库性能提升效果不明显，此时就要考虑对其进行切分了。切分的目的就在于减少数据库的负担，缩短查询的时间。</p>
<p>数据切分可以分为两种方式：垂直（纵向）划分和水平（横向）划分。</p>
<h3 id="垂直划分"><a class="markdownIt-Anchor" href="#垂直划分">#</a> 垂直划分</h3>
<p>垂直划分数据库是根据业务进行划分，例如将 shop 库中涉及商品、订单、用户的表分别划分出成一个库，通过降低单库的大小来提高性能，但这种方式并没有解决高数据量带来的性能损耗。同样的，分表的情况就是将一个大表根据业务功能拆分成一个个子表，例如商品基本信息和商品描述，商品基本信息一般会展示在商品列表，商品描述在商品详情页，可以将商品基本信息和商品描述拆分成两张表。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905918017/e130e5b8-b19a-4f1e-b860-223040525cf6.jpg" alt="垂直划分"></p>
<p>优点：行记录变小，数据页可以存放更多记录，在查询时减少 I/O 次数。</p>
<p>缺点：</p>
<ul>
<li>主键出现冗余，需要管理冗余列；</li>
<li>会引起表连接 JOIN 操作，可以通过在业务服务器上进行 join 来减少数据库压力；</li>
<li>依然存在单表数据量过大的问题。</li>
</ul>
<h3 id="水平划分"><a class="markdownIt-Anchor" href="#水平划分">#</a> 水平划分</h3>
<p>水平划分是根据一定规则，例如时间或 id 序列值等进行数据的拆分。比如根据年份来拆分不同的数据库。每个数据库结构一致，但是数据得以拆分，从而提升性能。</p>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905918231/63c2909f-0c5f-496f-9fe5-ee9176b31aba.jpg" alt="水平划分"></p>
<p>优点：单库（表）的数据量得以减少，提高性能；切分出的表结构相同，程序改动较少。</p>
<p>缺点：</p>
<ul>
<li>分片事务一致性难以解决</li>
<li>跨节点 Join 性能差，逻辑复杂</li>
<li>数据分片在扩容时需要迁移</li>
</ul>
<h2 id="日志"><a class="markdownIt-Anchor" href="#日志">#</a> 日志</h2>
<p>MySQL 日志 主要包括查询日志、慢查询日志、事务日志、错误日志、二进制日志等。其中比较重要的是二进制日志 binlog 和事务日志 redo log（重做日志）和 undo log（回滚日志）。</p>
<h3 id="bin-log"><a class="markdownIt-Anchor" href="#bin-log">#</a> bin log</h3>
<p>二进制日志（bin log）是 MySQL 数据库级别的文件，记录对 MySQL 数据库执行修改的所有操作，不会记录 select 和 show 语句，主要用于恢复数据库和同步数据库。</p>
<p>查看 bin log 是否开启，以及保存位置：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`MySQL&gt; show variables ``like` `&#x27;%log_bin%&#x27;``;``+``---------------------------------+----------------------------------------------------+``| Variable_name                   | Value                                              |``+``---------------------------------+----------------------------------------------------+``| log_bin                         | ``ON`                                                 `|``| log_bin_basename                | F:\java\MySQL8\data\Data\DESKTOP-8F30VS1-bin       |``| log_bin_index                   | F:\java\MySQL8\data\Data\DESKTOP-8F30VS1-bin.``index` `|``| log_bin_trust_function_creators | ``OFF`                                                `|``| log_bin_use_v1_row_events       | ``OFF`                                                `|``| sql_log_bin                     | ``ON`                                                 `|``+``---------------------------------+----------------------------------------------------+`</span><br></pre></td></tr></table></figure>
<p>关闭 bin log，找到 /etc/my.cnf 文件，注释以下代码：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`log-bin=MySQL-bin``binlog_format=mixed`</span><br></pre></td></tr></table></figure>
<h3 id="redo-log"><a class="markdownIt-Anchor" href="#redo-log">#</a> redo log</h3>
<p>重做日志（redo log）是 Innodb 引擎级别，用来记录 Innodb 存储引擎的事务日志，不管事务是否提交都会记录下来，用于数据恢复。当数据库发生故障，InnoDB 存储引擎会使用 redo log 恢复到发生故障前的时刻，以此来保证数据的完整性。将参数 innodb_flush_log_at_tx_commit 设置为 1，那么在执行 commit 时将 redo log 同步写到磁盘。</p>
<p>bin log 和 redo log 区别：</p>
<ol>
<li>bin log 会记录所有日志记录，包括 innoDB、MyISAM 等存储引擎的日志；redo log 只记录 innoDB 自身的事务日志</li>
<li>bin log 只在事务提交前写入到磁盘，一个事务只写一次，无论事务多大；而在事务进行过程，会有 redo log 不断写入磁盘</li>
<li>binlog 是逻辑日志，记录的是 SQL 语句的原始逻辑；redo log 是物理日志，记录的是在某个数据页上做了什么修改。</li>
</ol>
<h3 id="undo-log"><a class="markdownIt-Anchor" href="#undo-log">#</a> undo Log</h3>
<p>除了记录 redo log 外，当进行数据修改时还会记录 undo log，undo log 用于数据的撤回操作，它保留了记录修改前的内容。通过 undo log 可以实现事务回滚，并且可以根据 undo log 回溯到某个特定的版本的数据，实现 MVCC。</p>
<h3 id="查询日志"><a class="markdownIt-Anchor" href="#查询日志">#</a> 查询日志</h3>
<p>记录所有对 MySQL 请求的信息，无论请求是否正确执行。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`MySQL&gt; show variables ``like` `&#x27;%general_log%&#x27;``;``+``------------------+----------------------------------+``| Variable_name    | Value                            |``+``------------------+----------------------------------+``| general_log      | ``OFF`                              `|``| general_log_file | /var/lib/MySQL/VM_0_7_centos.log |``+``------------------+----------------------------------+`</span><br></pre></td></tr></table></figure>
<h2 id="mysql架构"><a class="markdownIt-Anchor" href="#mysql架构">#</a> MySQL 架构</h2>
<p>MySQL 主要分为 Server 层和存储引擎层：</p>
<ul>
<li><strong>Server 层</strong>：主要包括连接器、查询缓存、分析器、优化器、执行器等，所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图，函数等，还有一个通用的日志模块 binglog 日志模块。</li>
<li><strong>存储引擎</strong>： 主要负责数据的存储和读取。server 层通过 api 与存储引擎进行通信。</li>
</ul>
<p><img src="https://uploadfiles.nowcoder.com/files/20210825/8683776_1629905918396/mysql-archpng.png" alt="MySQL-archpng"></p>
<h3 id="server-层基本组件"><a class="markdownIt-Anchor" href="#server-层基本组件">#</a> Server 层基本组件</h3>
<ul>
<li><strong>连接器：</strong> 当<a href="">客户端</a>连接 MySQL 时，server 层会对其进行身份认证和权限校验。</li>
<li><strong>查询缓存:</strong> 执行查询语句的时候，会先查询缓存（MySQL 8.0 版本后移除），先校验这个 sql 是否执行过，如果缓存 key （sql 语句）被命中，就会直接返回给<a href="">客户端</a>，如果没有命中，就会执行后续的操作。MySQL 查询不建议使用缓存，因为查询缓存失效在实际业务场景中可能会非常频繁，不推荐使用。</li>
<li><strong>分析器:</strong> 没有命中缓存的话，SQL 语句就会经过分析器，主要分为两步，词法分析和语法分析，先看 SQL 语句要做什么，再检查 SQL 语句语法是否正确。</li>
<li><strong>优化器：</strong> 优化器对查询进行优化，包括重写查询、决定表的读写顺序以及选择合适的索引等，生成执行计划。</li>
<li><strong>执行器：</strong> 首先执行前会校验该用户有没有权限，如果没有权限，就会返回错误信息，如果有权限，就会根据执行计划去调用引擎的接口，返回结果。</li>
</ul>
<h4 id="语法解析器和预处理"><a class="markdownIt-Anchor" href="#语法解析器和预处理">#</a> 语法解析器和预处理</h4>
<p>MySQL 通过关键字将 SQL 语句进行解析，生成解析树。</p>
<p>MySQL 解析器使用 MySQL 语法规则验证和解析查询，比如验证是否使用正确的关键字、关键字的次序是否正确和验证引号是否前后正确匹配。</p>
<p>预处理器会进一步检查解析树是否合法，如检查数据表和数据列是否存在，然后验证权限。</p>
<h4 id="查询优化器"><a class="markdownIt-Anchor" href="#查询优化器">#</a> 查询优化器</h4>
<p>优化器会找出一个它认为最优的执行计划。</p>
<p>MySQL 能够处理的优化类型：</p>
<ol>
<li>重新定义表的关联顺序。数据表的关联并不是总按照查询中指定的顺序进行的。</li>
<li>使用等价变换，简化表达式。比如将  <code>5=5 AND a &gt; 5</code>  转化为  <code>a &gt; 5</code> 。</li>
<li>优化 COUNT/MIN/MAX。MIN 查询最小值，对应的是 b + 树索引的第一行记录，优化器会将这个表达式作为一个常数对待。</li>
<li>列表 IN () 的比较。很多数据库系统，IN 完成等价于多个 OR 子句。MySQL 不一样，MySQL 将 IN 列表的数据先进行<a href="">排序</a>，然后通过<a href="">二分查找</a>的方式确定列表的值是否符合要求，时间复杂度为 O (logN)，而 OR 查询的时间复杂度为 O (N)。当 IN 列表有大量取值时，处理速度相比 OR 查询会更快。</li>
<li>覆盖索引扫描。</li>
<li>将外连接转化成内连接。某些情况下，外连接可能等价于一个内连接。</li>
</ol>
<h4 id="查询执行引擎"><a class="markdownIt-Anchor" href="#查询执行引擎">#</a> 查询执行引擎</h4>
<p>在解析和优化阶段，MySQL 将生成查询对应的执行计划，MySQL 的查询执行引擎则根据这个执行计划，调用存储引擎接口来完成整个查询。</p>
<h3 id="查询语句执行流程"><a class="markdownIt-Anchor" href="#查询语句执行流程">#</a> 查询语句执行流程</h3>
<p>查询语句的执行流程如下：权限校验、查询缓存、分析器、优化器、权限校验、执行器、引擎。</p>
<p>查询语句：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`select` `* ``from` `user` `where` `id &gt; 1 ``and` `name` `= ``&#x27;大彬&#x27;``;`</span><br></pre></td></tr></table></figure>
<ol>
<li>检查权限，没有权限则返回错误；</li>
<li>MySQL 以前会查询缓存，缓存命中则直接返回，没有则执行下一步；</li>
<li>词法分析和语法分析。提取表名、查询条件，检查语法是否有错误；</li>
<li>两种执行方案，先查  <code>id &gt; 1</code>  还是  <code>name = '大彬'</code> ，优化器根据自己的优化<a href="">算法</a>选择执行效率最好的方案；</li>
<li>校验权限，有权限就调用数据库引擎接口，返回引擎的执行结果。</li>
</ol>
<h3 id="更新语句执行过程"><a class="markdownIt-Anchor" href="#更新语句执行过程">#</a> 更新语句执行过程</h3>
<p>更新语句执行流程如下：分析器、权限校验、执行器、引擎、redo log (prepare 状态)、binlog、redo log (commit 状态)</p>
<p>更新语句：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`update` `user` `set` `name` `= ``&#x27;大彬&#x27;` `where` `id = 1;`</span><br></pre></td></tr></table></figure>
<ol>
<li>先查询到 id 为 1 的记录，有缓存会使用缓存</li>
<li>拿到查询结果，将 name 更新为 大彬，然后调用引擎接口，写入更新数据，innodb 引擎将数据保存在内存中，同时记录 redo log，此时 redo log 进入 prepare 状态，然后告诉执行器，执行完成了，随时可以提交。</li>
<li>执行器收到通知后记录 binlog，然后调用引擎接口，提交 redo log 为提交状态。</li>
<li>更新完成。</li>
</ol>
<p>为什么记录完 redo log，不直接提交，先进入 prepare 状态？</p>
<p>假设先写 redo log 直接提交，然后写 binlog，写完 redo log 后，机器挂了，binlog 日志没有被写入，那么机器重启后，这台机器会通过 redo log 恢复数据，但是这个时候 binlog 并没有记录该数据，后续进行机器备份的时候，就会丢失这一条数据，同时主从同步也会丢失这一条数据。</p>
<p>假设写完了 binlog，机器异常重启了，由于没有 redo log，本机是无法恢复这一条记录的，但是 binlog 又有记录，那么和上面同样的道理，就会产生数据不一致的情况。</p>
<h2 id="慢查询"><a class="markdownIt-Anchor" href="#慢查询">#</a> 慢查询</h2>
<p>sql 语句查询时间超过（不包括等于） long_query_time，称为慢查询。</p>
<p>查看慢查询配置：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`show variables  ``like` `&#x27;%slow_query_log%&#x27;``; #查看慢查询配置``set` `global` `slow_query_log=1; #开启慢查询`</span><br></pre></td></tr></table></figure>
<p>使用 <code>set global slow_query_log=1</code>  开启了慢查询日志只对当前数据库生效，如果 MySQL 重启后则会失效。如果要永久生效，就必须修改配置文件 my.cnf。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`slow_query_log =``1``slow_query_log_file=/tmp/MySQL_slow.log #系统默认会给一个缺省的文件host_name-slow.log`</span><br></pre></td></tr></table></figure>
<p>默认情况下 long_query_time 的值为 10 秒，可以使用命令修改，也可以在 my.cnf 参数里面修改。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`show variables ``like` `&#x27;long_query_time%&#x27;``;``set` `global` `long_query_time=4; #需要重新连接或新开一个会话才能看到修改值或者使用show ``global` `variables ``like` `&#x27;long_query_time&#x27;`</span><br></pre></td></tr></table></figure>
<p>MySQL 数据库支持同时两种日志存储方式，配置的时候以逗号隔开即可，如：log_output=‘FILE,TABLE’。</p>
<p>日志记录到系统的专用日志表中，要比记录到文件耗费更多的系统资源，因此对于需要启用慢查询日志，又需要能够获得更高的系统性能，那么建议优先记录到文件。</p>
<h3 id="mysqldumpslow"><a class="markdownIt-Anchor" href="#mysqldumpslow">#</a> mysqldumpslow</h3>
<p>如果自己手动查找、分析 SQL，显然是个体力活，MySQL 提供了日志分析工具 mysqldumpslow。</p>
<p>获取执行时间最长的 10 条 sql 语句：</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`mysqldumpslow -s al -n 10 /usr/``local``/MySQL/data/slow.log`</span><br></pre></td></tr></table></figure>
<h2 id="分区表"><a class="markdownIt-Anchor" href="#分区表">#</a> 分区表</h2>
<p>分区表是一个独立的逻辑表，但是底层由多个物理子表组成。</p>
<p>当查询条件的数据分布在某一个分区的时候，查询引擎只会去某一个分区查询，而不是遍历整个表。在管理层面，如果需要删除某一个分区的数据，只需要删除对应的分区即可。</p>
<h3 id="分区表类型"><a class="markdownIt-Anchor" href="#分区表类型">#</a> 分区表类型</h3>
<ol>
<li>
<p>按照范围分区。</p>
<p><a href="#">复制代码</a></p>
<p><code>CREATE</code>   <code>TABLE</code>   <code>test_range_partition(``    ``id ``INT</code>   <code>auto_increment,``    ``createdate DATETIME,``    ``primary</code>   <code>key</code>   <code>(id,createdate)``) ``PARTITION ``BY</code>   <code>RANGE (TO_DAYS(createdate) ) (``   ``PARTITION p201801 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210201'``) ),``   ``PARTITION p201802 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210301'``) ),``   ``PARTITION p201803 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210401'``) ),``   ``PARTITION p201804 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210501'``) ),``   ``PARTITION p201805 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210601'``) ),``   ``PARTITION p201806 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210701'``) ),``   ``PARTITION p201807 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210801'``) ),``   ``PARTITION p201808 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20210901'``) ),``   ``PARTITION p201809 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20211001'``) ),``   ``PARTITION p201810 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20211101'``) ),``   ``PARTITION p201811 ``VALUES</code>   <code>LESS THAN ( TO_DAYS(``'20211201'``) )``);</code>   <code>insert</code>   <code>into</code>   <code>test_range_partition (createdate) ``values</code>   <code>(``'20210105'``);``insert</code>   <code>into</code>   <code>test_range_partition (createdate) ``values</code>   <code>(``'20210205'``);</code></p>
<p>在 <code>/var/lib/mysql/data/</code>  可以找到对应的数据文件，每个分区表都有一个使用 #分隔命名的表文件：</p>
<p><a href="#">复制代码</a></p>
<p><code>-rw-rw---- ``1</code>   <code>mysql mysql    ``65</code>   <code>Aug ``21</code>   <code>09``:``24</code>   <code>db.opt``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201801.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201802.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201803.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201804.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201805.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201806.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201807.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201808.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201809.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201810.ibd``-rw-rw---- ``1</code>   <code>mysql mysql ``98304</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition#P#p201811.ibd``-rw-rw---- ``1</code>   <code>mysql mysql  ``8598</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition.frm``-rw-rw---- ``1</code>   <code>mysql mysql   ``116</code>   <code>Aug ``21</code>   <code>09``:``27</code>   <code>test_range_partition.par</code></p>
</li>
<li>
<p>list 分区。对于 List 分区，分区字段必须是已知的，如果插入的字段不在分区时枚举值中，将无法插入。</p>
<p><a href="#">复制代码</a></p>
<p><code>create</code>   <code>table</code>   <code>test_list_partiotion``(``    ``id ``int</code>   <code>auto_increment,``    ``data_type tinyint,``    ``primary</code>   <code>key``(id,data_type)``)partition ``by</code>   <code>list(data_type)``(``    ``partition p0 ``values</code>   <code>in</code>   <code>(0,1,2,3,4,5,6),``    ``partition p1 ``values</code>   <code>in</code>   <code>(7,8,9,10,11,12),``    ``partition p2 ``values</code>   <code>in</code>   <code>(13,14,15,16,17)``);</code></p>
</li>
<li>
<p>hash 分区，可以将数据均匀地分布到预先定义的分区中。</p>
<p><a href="#">复制代码</a></p>
<p><code>drop</code>   <code>table</code>   <code>test_hash_partiotion;``create</code>   <code>table</code>   <code>test_hash_partiotion``(``    ``id ``int</code>   <code>auto_increment,``    ``create_date datetime,``    ``primary</code>   <code>key``(id,create_date)``)partition ``by</code>   <code>hash(``year``(create_date)) partitions 10;</code></p>
</li>
</ol>
<h3 id="分区的问题"><a class="markdownIt-Anchor" href="#分区的问题">#</a> 分区的问题</h3>
<ol>
<li>打开和锁住所有底层表的成本可能很高。当查询访问分区表时，MySQL 需要打开并锁住所有的底层表，这个操作在分区过滤之前发生，所以无法通过分区过滤来降低此开销，会影响到查询速度。可以通过批量操作来降低此类开销，比如批量插入、LOAD DATA INFILE 和一次删除多行数据。</li>
<li>维护分区的成本可能很高。例如重组分区，会先创建一个临时分区，然后将数据复制到其中，最后再删除原分区。</li>
<li>所有分区必须使用相同的存储引擎。</li>
</ol>
<h3 id="查询优化"><a class="markdownIt-Anchor" href="#查询优化">#</a> 查询优化</h3>
<p>分区最大的优点就是优化器可以根据分区函数过滤掉一些分区，可以让查询扫描更少的数据。在查询条件中加入分区列，就可以让优化器过滤掉无需访问的分区。如果查询条件没有分区列，MySQL 会让存储引擎访问这个表的所有分区。需要注意的是，查询条件中的分区列不能使用表达式。</p>
<h2 id="其他"><a class="markdownIt-Anchor" href="#其他">#</a> 其他</h2>
<h3 id="processlist"><a class="markdownIt-Anchor" href="#processlist">#</a> processlist</h3>
<p><code>select *</code>  会查询出不需要的、额外的数据，那么这些额外的数据在网络上进行传输，带来了额外的网络开销。</p>
<p><code>show processlist</code>  或  <code>show full processlist</code>  可以查看当前 MySQL 是否有压力，正在运行的 sql，有没有慢 SQL 正在执行。</p>
<ul>
<li>
<p><strong>id</strong> - 线程 ID，可以用： <code>kill id;</code>  杀死一个线程，很有用</p>
</li>
<li>
<p><strong>db</strong> - 数据库</p>
</li>
<li>
<p><strong>user</strong> - 用户</p>
</li>
<li>
<p><strong>host</strong> - 连库的主机 IP</p>
</li>
<li>
<p><strong>command</strong> - 当前执行的命令，比如最常见的：Sleep，Query，Connect 等</p>
</li>
<li>
<p><strong>time</strong> - 消耗时间，单位秒，很有用</p>
</li>
<li>
<p><strong>state</strong> - 执行状态</p>
<p>sleep，线程正在等待<a href="">客户端</a>发送新的请求</p>
<p>query，线程正在查询或者正在将结果发送到<a href="">客户端</a></p>
<p>Sorting result，线程正在对结果集进行<a href="">排序</a></p>
<p>Locked，线程正在等待锁</p>
</li>
<li>
<p><strong>info</strong> - 执行的 SQL 语句，很有用</p>
</li>
</ul>
<h3 id="exist和in"><a class="markdownIt-Anchor" href="#exist和in">#</a> exist 和 in</h3>
<p>exists 用于对外表记录做筛选。</p>
<p>exists 会遍历外表，将外查询表的每一行，代入内查询进行判断。当 exists 里的条件语句能够返回记录行时，条件就为真，返回外表当前记录。反之如果 exists 里的条件语句不能返回记录行，条件为假，则外表当前记录被丢弃。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`select` `a.* ``from` `A a``where` `exists(``select` `1 ``from` `B b ``where` `a.id=b.id)`</span><br></pre></td></tr></table></figure>
<p>in 是先把后边的语句查出来放到临时表中，然后遍历临时表，将临时表的每一行，代入外查询去查找。</p>
<p><a href="#">复制代码</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`select` `* ``from` `A``where` `id ``in``(``select` `id ``from` `B)`</span><br></pre></td></tr></table></figure>
<p>子查询的表大的时候，使用 EXISTS 可以有效减少总的循环次数来提升速度；当外查询的表大的时候，使用 IN 可以有效减少对外查询表循环遍历来提升速度。</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post_share"><div class="social-share" data-image="/img/me.png" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2021/09/05/%E9%9B%86%E5%90%88%E9%97%AE%E9%A2%98/"><img class="next-cover" src="/img/6.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">集合问题</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/me1.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Kris</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">2</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/brave-rabbit"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%89%B9%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text"> 事务特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">2.</span> <span class="toc-text"> 事务隔离级别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">3.</span> <span class="toc-text"> 索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text"> 索引的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-%E6%A0%91"><span class="toc-number">3.2.</span> <span class="toc-text"> B+ 树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%AE%9E%E4%BE%8B"><span class="toc-number">3.3.</span> <span class="toc-text"> 索引实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="toc-number">3.4.</span> <span class="toc-text"> 索引分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D"><span class="toc-number">3.5.</span> <span class="toc-text"> 最左匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E9%9B%86%E7%B4%A2%E5%BC%95"><span class="toc-number">3.6.</span> <span class="toc-text"> 聚集索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="toc-number">3.7.</span> <span class="toc-text"> 覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-number">3.8.</span> <span class="toc-text"> 索引失效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">4.</span> <span class="toc-text"> 存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb"><span class="toc-number">4.1.</span> <span class="toc-text"> InnoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#myisam"><span class="toc-number">4.2.</span> <span class="toc-text"> MyISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#memory"><span class="toc-number">4.3.</span> <span class="toc-text"> MEMORY</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#myisam%E5%92%8Cinnodb%E5%8C%BA%E5%88%AB"><span class="toc-number">4.4.</span> <span class="toc-text"> MyISAM 和 InnoDB 区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mvcc"><span class="toc-number">5.</span> <span class="toc-text"> MVCC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text"> 实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read-view"><span class="toc-number">5.2.</span> <span class="toc-text"> read view</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">5.3.</span> <span class="toc-text"> 数据访问流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7%E8%AF%BB%E5%92%8C%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="toc-number">5.4.</span> <span class="toc-text"> 快照读和当前读</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select-%E8%AF%BB%E5%8F%96%E9%94%81%E5%AE%9A"><span class="toc-number">5.5.</span> <span class="toc-text"> select 读取锁定</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">6.</span> <span class="toc-text"> 分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9E%82%E7%9B%B4%E5%88%92%E5%88%86"><span class="toc-number">6.1.</span> <span class="toc-text"> 垂直划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E5%88%92%E5%88%86"><span class="toc-number">6.2.</span> <span class="toc-text"> 水平划分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">7.</span> <span class="toc-text"> 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bin-log"><span class="toc-number">7.1.</span> <span class="toc-text"> bin log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redo-log"><span class="toc-number">7.2.</span> <span class="toc-text"> redo log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#undo-log"><span class="toc-number">7.3.</span> <span class="toc-text"> undo Log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">7.4.</span> <span class="toc-text"> 查询日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E6%9E%B6%E6%9E%84"><span class="toc-number">8.</span> <span class="toc-text"> MySQL 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#server-%E5%B1%82%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6"><span class="toc-number">8.1.</span> <span class="toc-text"> Server 层基本组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E8%A7%A3%E6%9E%90%E5%99%A8%E5%92%8C%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">8.1.1.</span> <span class="toc-text"> 语法解析器和预处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%99%A8"><span class="toc-number">8.1.2.</span> <span class="toc-text"> 查询优化器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E"><span class="toc-number">8.1.3.</span> <span class="toc-text"> 查询执行引擎</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">8.2.</span> <span class="toc-text"> 查询语句执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">8.3.</span> <span class="toc-text"> 更新语句执行过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2"><span class="toc-number">9.</span> <span class="toc-text"> 慢查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysqldumpslow"><span class="toc-number">9.1.</span> <span class="toc-text"> mysqldumpslow</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8"><span class="toc-number">10.</span> <span class="toc-text"> 分区表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">10.1.</span> <span class="toc-text"> 分区表类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">10.2.</span> <span class="toc-text"> 分区的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">10.3.</span> <span class="toc-text"> 查询优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">11.</span> <span class="toc-text"> 其他</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#processlist"><span class="toc-number">11.1.</span> <span class="toc-text"> processlist</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exist%E5%92%8Cin"><span class="toc-number">11.2.</span> <span class="toc-text"> exist 和 in</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/09/05/mysql%E9%A2%98%E7%9B%AE/" title="mysql问题"><img src="/img/me.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql问题"/></a><div class="content"><a class="title" href="/2021/09/05/mysql%E9%A2%98%E7%9B%AE/" title="mysql问题">mysql问题</a><time datetime="2021-09-05T14:02:14.000Z" title="发表于 2021-09-05 22:02:14">2021-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/05/%E9%9B%86%E5%90%88%E9%97%AE%E9%A2%98/" title="集合问题"><img src="/img/6.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="集合问题"/></a><div class="content"><a class="title" href="/2021/09/05/%E9%9B%86%E5%90%88%E9%97%AE%E9%A2%98/" title="集合问题">集合问题</a><time datetime="2021-09-05T01:26:59.000Z" title="发表于 2021-09-05 09:26:59">2021-09-05</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/me.png')"><div id="footer-wrap"><div class="copyright">&copy;2021 By Kris</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">联系vx：Mizika02</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'hello-cloudbase-6gi7gi2qdd31baea',
      region: 'ap-shanghai'
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'hello-cloudbase-6gi7gi2qdd31baea',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><div class="aplayer no-destroy" data-id="6921693374" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script async src="/js/custom.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '#bgm-test',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><!-- hexo injector body_end start --><script data-pjax>
                        function butterfly_swiper_injector_config(){
                          var parent_div_git = document.getElementById('recent-posts');
                          var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
                          console.log('已挂载butterfly_swiper')
                          // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                          parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
                          }
                        if( document.getElementById('recent-posts') && (location.pathname ==='all'|| 'all' ==='all')){
                        butterfly_swiper_injector_config()
                        }
                      </script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.1.6/js/swiper.min.js"></script><script defer data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>